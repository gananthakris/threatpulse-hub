'use client';

import { useState, useEffect } from 'react';
import {
  Box,
  Typography,
  Paper,
  Button,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Chip,
  Grid,
  Card,
  CardContent,
  CircularProgress,
  Alert,
  IconButton,
} from '@mui/material';
import RefreshIcon from '@mui/icons-material/Refresh';
import CloudDownloadIcon from '@mui/icons-material/CloudDownload';
import SecurityIcon from '@mui/icons-material/Security';
import BugReportIcon from '@mui/icons-material/BugReport';

const STORAGE_KEY = 'threatpulse_samples';

interface MalwareSample {
  id: string;
  sha256Hash: string;
  md5Hash?: string;
  fileName: string;
  fileType: string;
  signature: string;
  firstSeen: string;
  originCountry: string;
  threatLevel: 'CRITICAL' | 'HIGH' | 'MEDIUM' | 'LOW';
  threatScore: number;
  tags: string[];
  reporter?: string;
}

export default function MalwareDashboard() {
  const [samples, setSamples] = useState<MalwareSample[]>([]);
  const [loading, setLoading] = useState(false);
  const [stats, setStats] = useState({
    totalSamples: 0,
    criticalThreats: 0,
    highThreats: 0,
    uniqueFamilies: 0,
  });
  const [status, setStatus] = useState<{ message: string; type: 'success' | 'error' | 'info' } | null>(null);
  const [lastFetched, setLastFetched] = useState<string | null>(null);

  useEffect(() => {
    const stored = loadFromStorage();
    const FIVE_MIN = 5 * 60 * 1000;
    const isStale = !stored || (Date.now() - new Date(stored.fetchedAt).getTime() > FIVE_MIN);
    if (isStale) {
      fetchFromMalwareBazaar();
    }
  }, []);

  const loadFromStorage = (): { samples: MalwareSample[]; fetchedAt: string } | null => {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        const parsed = JSON.parse(stored) as { samples: MalwareSample[]; fetchedAt: string };
        setSamples(parsed.samples);
        setLastFetched(parsed.fetchedAt);
        computeStats(parsed.samples);
        return parsed;
      }
    } catch {
      // Ignore storage errors
    }
    return null;
  };

  const computeStats = (data: MalwareSample[]) => {
    const critical = data.filter(s => s.threatLevel === 'CRITICAL').length;
    const high = data.filter(s => s.threatLevel === 'HIGH').length;
    const families = new Set(data.map(s => s.signature).filter(s => s && s !== 'Unknown')).size;
    setStats({
      totalSamples: data.length,
      criticalThreats: critical,
      highThreats: high,
      uniqueFamilies: families,
    });
  };

  const fetchFromMalwareBazaar = async () => {
    try {
      setLoading(true);
      setStatus({ message: 'Fetching live threat data from MalwareBazaar...', type: 'info' });

      const response = await fetch('/api/malware-collect');
      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const result = await response.json();
      if (!result.success) throw new Error(result.error || 'Fetch failed');

      const fetchedSamples: MalwareSample[] = result.samples;
      setSamples(fetchedSamples);
      setLastFetched(result.fetchedAt);
      computeStats(fetchedSamples);

      // Persist to localStorage
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        samples: fetchedSamples,
        fetchedAt: result.fetchedAt,
      }));

      setStatus({
        message: `Fetched ${result.count} live samples from MalwareBazaar (${new Date(result.fetchedAt).toLocaleTimeString()})`,
        type: 'success',
      });
    } catch (error) {
      console.error('Fetch error:', error);
      setStatus({ message: `Error: ${error instanceof Error ? error.message : 'Unknown error'}`, type: 'error' });
    } finally {
      setLoading(false);
    }
  };

  const getThreatChipColor = (level: string): 'error' | 'warning' | 'info' | 'success' | 'default' => {
    switch (level) {
      case 'CRITICAL': return 'error';
      case 'HIGH': return 'warning';
      case 'MEDIUM': return 'info';
      case 'LOW': return 'success';
      default: return 'default';
    }
  };

  return (
    <Box sx={{ p: 3 }}>
      {/* Header */}
      <Box sx={{ mb: 4 }}>
        <Typography variant="h4" sx={{ fontWeight: 700, mb: 1, display: 'flex', alignItems: 'center', gap: 1 }}>
          <SecurityIcon fontSize="large" />
          ThreatPulse Intelligence Hub
        </Typography>
        <Typography variant="body1" sx={{ color: 'text.secondary' }}>
          Advanced Cyber Threat Intelligence & Malware Analysis Platform — Live data from MalwareBazaar
        </Typography>
      </Box>

      {/* Stats Cards */}
      <Grid container spacing={3} sx={{ mb: 4 }}>
        <Grid size={{ xs: 12, sm: 6, md: 3 }}>
          <Card>
            <CardContent>
              <Typography color="textSecondary" gutterBottom variant="overline">
                Total Samples
              </Typography>
              <Typography variant="h4" component="div">
                {stats.totalSamples}
              </Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid size={{ xs: 12, sm: 6, md: 3 }}>
          <Card sx={{ bgcolor: 'error.light' }}>
            <CardContent>
              <Typography gutterBottom variant="overline" sx={{ color: 'error.contrastText' }}>
                Critical Threats
              </Typography>
              <Typography variant="h4" component="div" sx={{ color: 'error.contrastText' }}>
                {stats.criticalThreats}
              </Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid size={{ xs: 12, sm: 6, md: 3 }}>
          <Card sx={{ bgcolor: 'warning.light' }}>
            <CardContent>
              <Typography gutterBottom variant="overline" sx={{ color: 'warning.contrastText' }}>
                High Threats
              </Typography>
              <Typography variant="h4" component="div" sx={{ color: 'warning.contrastText' }}>
                {stats.highThreats}
              </Typography>
            </CardContent>
          </Card>
        </Grid>
        <Grid size={{ xs: 12, sm: 6, md: 3 }}>
          <Card>
            <CardContent>
              <Typography color="textSecondary" gutterBottom variant="overline">
                Unique Families
              </Typography>
              <Typography variant="h4" component="div">
                {stats.uniqueFamilies}
              </Typography>
            </CardContent>
          </Card>
        </Grid>
      </Grid>

      {/* Actions and Status */}
      <Paper sx={{ p: 3, mb: 4 }}>
        <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>
          <Box>
            <Typography variant="h6">Live Threat Intelligence</Typography>
            {lastFetched && (
              <Typography variant="caption" color="text.secondary">
                Last fetched: {new Date(lastFetched).toLocaleString()}
              </Typography>
            )}
          </Box>
          <Box sx={{ display: 'flex', gap: 2 }}>
            <Button
              variant="contained"
              startIcon={loading ? <CircularProgress size={16} color="inherit" /> : <CloudDownloadIcon />}
              onClick={fetchFromMalwareBazaar}
              disabled={loading}
            >
              {loading ? 'Fetching...' : 'Refresh'}
            </Button>
            <IconButton onClick={loadFromStorage} disabled={loading} title="Reload from cache">
              <RefreshIcon />
            </IconButton>
          </Box>
        </Box>
        {status && (
          <Alert severity={status.type} onClose={() => setStatus(null)}>
            {status.message}
          </Alert>
        )}
      </Paper>

      {/* Samples Table */}
      <Paper>
        <Box sx={{ p: 2, borderBottom: 1, borderColor: 'divider' }}>
          <Typography variant="h6">
            Recent Malware Samples
            {samples.length > 0 && (
              <Typography component="span" variant="body2" color="text.secondary" sx={{ ml: 1 }}>
                ({samples.length} samples)
              </Typography>
            )}
          </Typography>
        </Box>

        {loading && samples.length === 0 ? (
          <Box sx={{ display: 'flex', justifyContent: 'center', p: 4 }}>
            <CircularProgress />
          </Box>
        ) : samples.length === 0 ? (
          <Box sx={{ p: 4, textAlign: 'center' }}>
            <BugReportIcon sx={{ fontSize: 48, color: 'text.secondary', mb: 2 }} />
            <Typography variant="body1" color="text.secondary">
              Loading live threat data from MalwareBazaar&hellip;
            </Typography>
          </Box>
        ) : (
          <TableContainer>
            <Table size="small">
              <TableHead>
                <TableRow>
                  <TableCell>Threat Level</TableCell>
                  <TableCell>Score</TableCell>
                  <TableCell>File Name</TableCell>
                  <TableCell>Signature</TableCell>
                  <TableCell>Type</TableCell>
                  <TableCell>First Seen</TableCell>
                  <TableCell>SHA256</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {samples.slice(0, 50).map((sample) => (
                  <TableRow key={sample.id} hover>
                    <TableCell>
                      <Chip
                        label={sample.threatLevel}
                        color={getThreatChipColor(sample.threatLevel)}
                        size="small"
                      />
                    </TableCell>
                    <TableCell>{sample.threatScore}</TableCell>
                    <TableCell sx={{ maxWidth: 200, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                      {sample.fileName}
                    </TableCell>
                    <TableCell>{sample.signature !== 'Unknown' ? sample.signature : '—'}</TableCell>
                    <TableCell>{sample.fileType}</TableCell>
                    <TableCell sx={{ whiteSpace: 'nowrap' }}>
                      {new Date(sample.firstSeen).toLocaleDateString()}
                    </TableCell>
                    <TableCell>
                      <Typography variant="body2" sx={{ fontFamily: 'monospace', fontSize: '0.75rem' }}>
                        {sample.sha256Hash.substring(0, 16)}…
                      </Typography>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        )}
      </Paper>
    </Box>
  );
}
